<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
  Projects that only include templates do not need to include or deploy
  certain files in the VSIX.
  
  By default, we don't even create a VSIX, since the project may contain
  exactly one template that is referenced by a single project that creates
  the VSIX. This last project explicitly sets CreateVisxContainer to true.
  -->
  <PropertyGroup Condition="$(UseVSSDKTemplateOnly)">
    <CreateVsixContainer Condition="'$(CreateVsixContainer)' == ''">false</CreateVsixContainer>
    <CopyVsixManifestToOutput>$(CreateVsixContainer)</CopyVsixManifestToOutput>
    <GeneratePkgDefFile Condition="'$(GeneratePkgDefFile)' == ''">false</GeneratePkgDefFile>
    <DeployExtension>false</DeployExtension>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>
    <IncludeVSIXItemsFromTargets>BuiltVsixTemplateItems</IncludeVSIXItemsFromTargets>
  </PropertyGroup>

  <PropertyGroup Condition="!$(UseVSSDK) and !$(UseVSSDKTemplateOnly)">
    <DeployVSTemplates>false</DeployVSTemplates>
    <DeployExtension>false</DeployExtension>
    <CopyVsixExtensionFiles>false</CopyVsixExtensionFiles>
    <CreateVsixContainer>false</CreateVsixContainer>
    <CopyVsixManifestToOutput>false</CopyVsixManifestToOutput>
    <GeneratePkgDefFile>false</GeneratePkgDefFile>
    <IncludePkgdefInVSIXContainer>false</IncludePkgdefInVSIXContainer>
  </PropertyGroup>

  <PropertyGroup>
    <!--
    To specify a different registry root to register your package, uncomment the TargetRegistryRoot
    tag and specify a registry root in it.
    <TargetRegistryRoot></TargetRegistryRoot>
    -->
    <RegisterWithCodebase Condition="'$(RegisterWithCodebase)' == ''">true</RegisterWithCodebase>
  </PropertyGroup>

  <!--
  Inside Visual Studio, we want to deploy to the experimental hive when
  building for ease of debugging.
  -->
  <PropertyGroup Condition="'$(BuildingInsideVisualStudio)' == 'true'">
    <DeployExtension Condition="'$(DeployExtension)' == ''">true</DeployExtension>
    <DeployVSTemplates Condition="'$(DeployVSTemplates)' == ''">false</DeployVSTemplates>
    <CreateVsixContainer Condition="'$(CreateVsixContainer)' == ''">false</CreateVsixContainer>
    <CopyVsixManifestToOutput Condition="'$(CopyVsixManifestToOutput)' == ''">true</CopyVsixManifestToOutput>
    <RegisterOutputPackage Condition="'$(RegisterOutputPackage)' == ''">true</RegisterOutputPackage>
  </PropertyGroup>
  
  <!--
  Outside of Visual Studio, we want to create VSIX containers rather than
  deploying to the experimental hive.
  -->
  <PropertyGroup Condition="'$(BuildingInsideVisualStudio)' != 'true'">
    <DeployExtension Condition="'$(DeployExtension)' == ''">false</DeployExtension>
    <DeployVSTemplates Condition="'$(DeployVSTemplates)' == ''">false</DeployVSTemplates>
    <CreateVsixContainer Condition="'$(CreateVsixContainer)' == ''">false</CreateVsixContainer>
    <CopyVsixManifestToOutput Condition="'$(CopyVsixManifestToOutput)' == ''">true</CopyVsixManifestToOutput>
    <RegisterOutputPackage Condition="'$(RegisterOutputPackage)' == ''">false</RegisterOutputPackage>
  </PropertyGroup>

  <!--
  If a VSIX is being created, we want to copy its contents to a location
  where it can be signed and zipped.
  -->
  <PropertyGroup Condition="$(CreateVsixContainer)">
    <CopyVsixExtensionFiles Condition="'$(CopyVsixExtensionFiles)' == ''">true</CopyVsixExtensionFiles>
    <CopyVsixExtensionLocation>$(CopyVsixExtensionRoot)$(TargetName)\</CopyVsixExtensionLocation>
    <TargetVsixContainerName Condition="'$(TargetVsixContainerName)'==''">$(TargetName).vsix</TargetVsixContainerName>
    <TargetVsixContainer Condition="'$(TargetVsixContainer)'==''">$(SetupOutputPath)$(TargetVsixContainerName)</TargetVsixContainer>
  </PropertyGroup>

  <Target Name="_CreateVsixContainerPath" Condition="$(CreateVsixContainer) and !Exists('$(SetupOutputPath)')" BeforeTargets="PrepareForBuild">
    <MakeDir Directories="$(SetupOutputPath)" ContinueOnError="true" />
  </Target>

  <PropertyGroup>
    <VSSDKTargets>$(BuildRoot)\BuildOutput\Microsoft.VSSDK.BuildTools.14.0.23205\tools\VSSDK\Microsoft.VsSDK.targets</VSSDKTargets>
  </PropertyGroup>
  
  <!-- Import the VS SDK headers -->
  <Import Project="$(VSSDKTargets)" Condition="Exists($(VSSDKTargets))" />
  <Import Project="$(VSToolsPath)\VSSDK\Microsoft.VsSDK.targets" Condition="!Exists($(VSSDKTargets))" />

  <!-- For non-debug builds, don't copy debug symbols -->
  <Target Name="_ClearVSIXSourceItemLocalOnly"
          BeforeTargets="CopyVsixExtensionFiles"
          Condition="$(CreateVsixContainer) and $(Configuration) != 'Debug'">
    <ItemGroup>
      <_VSIXSourceItemLocalOnly Include="@(VSIXSourceItemLocalOnly)" />
      <VSIXSourceItemLocalOnly Remove="@(VSIXSourceItemLocalOnly)" />
    </ItemGroup>
  </Target>

  <Target Name="_RestoreVSIXSourceItemLocalOnly"
          AfterTargets="CopyVsixExtensionFiles"
          Condition="$(CreateVsixContainer) and $(Configuration) != 'Debug'">
    <ItemGroup>
      <VSIXSourceItemLocalOnly Include="@(_VSIXSourceItemLocalOnly)" />
      <_VSIXSourceItemLocalOnly Remove="@(_VSIXSourceItemLocalOnly)" />
    </ItemGroup>
  </Target>
  
  <!--
  Our GetVSIXSourceItems does not trigger vsixmanifest generation, so update
  the target dependencies to bypass it.
  -->
  <PropertyGroup>
    <ValidateVsixPartsDependsOn>DetokenizeVsixManifestFile;$(ValidateVsixPartsDependsOn)</ValidateVsixPartsDependsOn>
  </PropertyGroup>

  <!-- Provide a target to include templates -->
  <Target Name="BuiltVsixTemplateItems"
          DependsOnTargets="ZipProjects;ZipItems"
          Returns="@(TemplateZip)">
    <ItemGroup>
      <TemplateZip Include="@(IntermediateZipItem)">
        <TemplateSubPath>ItemTemplates\%(IntermediateZipItem.Language)\%(IntermediateZipItem.OutputSubPath)\%(IntermediateZipItem.Culture)</TemplateSubPath>
      </TemplateZip>
      <TemplateZip Include="@(IntermediateZipProject)">
        <TemplateSubPath>ProjectTemplates\%(IntermediateZipProject.Language)\%(IntermediateZipProject.OutputSubPath)\%(IntermediateZipProject.Culture)</TemplateSubPath>
      </TemplateZip>
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <IncludeVSIXItemsFromTargets Condition="!$(UseVSSDKTemplateOnly)">$(IncludeVSIXItemsFromTargets);BuiltVsixTemplateItems</IncludeVSIXItemsFromTargets>
  </PropertyGroup>


  <!-- Copy built templates to the project's output directory -->
  <Target Name="CopyTemplatesToOutput"
          DependsOnTargets="BuiltVsixTemplateItems"
          Inputs="@(TemplateZip)"
          Outputs="@(TemplateZip->'$(OutputPath)%(TemplateSubPath)\%(Filename)%(Extension)')"
          AfterTargets="CopyFilesToOutputDirectory">
    <Copy SourceFiles="@(TemplateZip)"
          DestinationFiles="@(TemplateZip->'$(OutputPath)%(TemplateSubPath)\%(Filename)%(Extension)')"
          SkipUnchangedFiles="true">
      <Output TaskParameter="CopiedFiles" ItemName="FileWrites"/>
    </Copy>
  </Target>
  
  <!-- Copy extension files to the project's output directory -->
  <Target Name="CopyVSSDKFilesToOutput"
          DependsOnTargets="CopyVsixManifestFile;CopyPkgDef"
          BeforeTargets="AfterBuild" />
  
  <!--
  Copies the VS-specific theme file to the output directory.
  
  Themes should be stored in a Theme directory of the project and be named
  matching the output assembly and the target VS version, for example:
      Microsoft.PythonTools.theme.v12.0.pkgdef
  -->
  <ItemGroup>
    <_ThemePkgDef Include="Theme\**\*.theme.v$(VSTarget).pkgdef">
      <IntermediateFile>$(IntermediateOutputPath)$([System.String]::New(`%(Identity)`).Replace(`.v$(VSTarget)`, ``))</IntermediateFile>
    </_ThemePkgDef>
  </ItemGroup>

  <Target Name="_IncludeThemePkgdef" BeforeTargets="PrepareForBuild" Inputs="@(_ThemePkgDef)" Outputs="@(_ThemePkgDef->'%(IntermediateFile)')">
    <Copy SourceFiles="@(_ThemePkgDef)"
          DestinationFiles="@(_ThemePkgDef->'%(IntermediateFile)')">
        <Output TaskParameter="CopiedFiles" ItemName="_CopiedThemePkgDef" />
        <Output TaskParameter="CopiedFiles" ItemName="FileWrites" />
    </Copy>
    <ItemGroup>
      <Content Include="@(_ThemePkgDef->'%(IntermediateFile)')">
        <IncludeInVsix>true</IncludeInVsix>
        <VSIXSubPath>.</VSIXSubPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </Content>
    </ItemGroup>
  </Target>


  <!--
  Zip folders containing VSIX files. These folders must have been created
  by previously having built the project.
  -->
  <Target Name="_GetRezipVSIXFiles" Condition="$([msbuild]::ValueOrDefault($(RezipVSIXFiles), `false`))">
    <ItemGroup>
      <VSIX Include="$(CopyVsixExtensionRoot)*\extension.vsixmanifest" />
      <VSIX>
        <SourceDir>%(VSIX.RootDir)%(VSIX.Directory)</SourceDir>
        <Container>$(SetupOutputPath)$([System.IO.Path]::GetFileName($([System.String]::new(%(VSIX.Directory)).TrimEnd(`\`)))).vsix</Container>
      </VSIX>
    </ItemGroup>
  </Target>
  
  <Target Name="_RezipSingleVSIX_Dev12_14" DependsOnTargets="_GetRezipVSIXFiles" BeforeTargets="Build" Inputs="@(VSIX)" Outputs="%(VSIX.Container)" Condition="'$(VSTarget)' == '12.0' or '$(VSTarget)' == '14.0'">
    <Message Text="Rezipping %(VSIX.SourceDir) to %(VSIX.Container)" Importance="high" />
    
    <ItemGroup>
      <_VSIXSourceItems Include="%(VSIX.SourceDir)**\*" />
      <_VSIXSourceItems>
        <TargetPath>%(RecursiveDir)%(Filename)%(Extension)</TargetPath>
      </_VSIXSourceItems>
    </ItemGroup>
    
    <PropertyGroup>
      <_Container>%(VSIX.Container)</_Container>
    </PropertyGroup>

    <CreateZipPackage Files="@(_VSIXSourceItems)" ZipPackage="$(_Container)" CompressionLevel="$(ZipPackageCompressionLevel)">
      <Output TaskParameter="ZipPackage" ItemName="FileWrites" />
      <Output TaskParameter="ZipPackage" ItemName="_FilesToSign" />
    </CreateZipPackage>

    <ItemGroup>
      <FilesToSign Include="$(_Container)">
        <Authenticode>vsix</Authenticode>
      </FilesToSign>
    </ItemGroup>
  </Target>

  <Target Name="_RezipSingleVSIX_Dev10_11" DependsOnTargets="_GetRezipVSIXFiles" BeforeTargets="Build" Inputs="@(VSIX)" Outputs="%(VSIX.Container)" Condition="'$(VSTarget)' == '10.0' or '$(VSTarget)' == '11.0'">
    <Message Text="Rezipping %(VSIX.SourceDir)" Importance="high" />
    
    <ItemGroup>
      <_VSIXSourceItems Include="%(VSIX.SourceDir)**\*" />
      <_VSIXSourceItems>
        <TargetPath>%(RecursiveDir)%(Filename)%(Extension)</TargetPath>
      </_VSIXSourceItems>
    </ItemGroup>

    <PropertyGroup>
      <_Container>%(VSIX.Container)</_Container>
    </PropertyGroup>

    <CreateZipPackage Files="@(_VSIXSourceItems)" ZipPackage="$(_Container)">
      <Output TaskParameter="ZipPackage" ItemName="FileWrites" />
    </CreateZipPackage>
  </Target>

  <!--
  Transforms TransformedZipProject items into ZipProject items with textual
  replacement of the VS target version.
  
  The original files should include an extra extension (typically .base)
  which will be stripped when the file is tranformed.
  -->
  <Target Name="TransformZipProject"
          BeforeTargets="MainResourcesGeneration"
          Condition="'@(TransformedZipProject)' != ''">
    <WriteLinesToFile
      File="@(TransformedZipProject->'%(RootDir)%(Directory)%(Filename)')"
      Lines="$([System.IO.File]::ReadAllText('%(fullpath)').Replace(&quot;_VSVERSION_&quot;,&quot;$(VSTarget)&quot;))"
      Overwrite="true"/>

    <ItemGroup>
      <ZipProject Include="@(TransformedZipProject->'%(RootDir)%(Directory)%(Filename)')" />
    </ItemGroup>
  </Target>

  <!--
  If this package is building a VSIX and InstalledByMsi property is set to
  False, edit the intermediate manifest to reflect that.
  -->
  <Target Name="EditIntermediateVsixManifest"
          AfterTargets="DetokenizeVsixManifestFile"
          Condition="!$([msbuild]::ValueOrDefault($(InstalledByMsi), `true`))">
    <PropertyGroup>
      <_VsixManifestSchemaNamespaces>
        <![CDATA[
          <Namespace Prefix="vsx10" Uri="http://schemas.microsoft.com/developer/vsx-schema/2010"/>
          <Namespace Prefix="vsx11" Uri="http://schemas.microsoft.com/developer/vsx-schema/2011"/>
      ]]>
      </_VsixManifestSchemaNamespaces>
    </PropertyGroup>
    
    <XmlPoke XmlInputPath="$(IntermediateVsixManifest)"
             Namespaces="$(_VsixManifestSchemaNamespaces)"
             Query="/vsx10:Vsix/vsx10:Identifier/vsx10:InstalledByMsi"
             Value="false" />
    <XmlPoke XmlInputPath="$(IntermediateVsixManifest)"
             Namespaces="$(_VsixManifestSchemaNamespaces)"
             Query="/vsx11:PackageManifest/vsx11:Installation/@InstalledByMsi"
             Value="false" />
  </Target>


</Project>
